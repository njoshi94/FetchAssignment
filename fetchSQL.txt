SELECT f.Date, f.name, f.rank, f.count
FROM
	(SELECT e.Date. e.name, rank() over (partition by e.Date order by e.count desc) as rank, e.count
	FROM
		(SELECT d.Date, d.name, COUNT(d.name) as count 
		FROM 
			(SELECT FORMAT(DATEADD(SECOND, cast(a.dateScanned as bigint) / 1000, '19700101'), 'yyyy-MM') as Date, c.name
			FROM (SELECT receiptID, dateScanned from receipts) a
			INNER JOIN (SELECT receiptID, barcode FROM RewardsReceiptItemList) b 
			ON a.receiptID = b.receiptID
			INNER JOIN (SELECT barcode, name FROM Brands) c
			ON b.barcode = c.barcode ) d
		GROUP BY d.Date, d.name ) e
	WHERE e.Date IN 
		(SELECT DISTINCT TOP 2 FORMAT(DATEADD(SECOND, cast(a.dateScanned as bigint) / 1000, '19700101'), 'yyyy-MM') as Date 
		FROM (SELECT dateScanned FROM receipts) a ORDER BY date DESC)) f
WHERE rank <=5
ORDER BY f.Date DESC, f.Rank ASC 
